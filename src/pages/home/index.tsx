import type { NextPage } from "next";
import Head from "next/head";
// import Image from "next/image";
// import styles from "../styles/Project.module.css";
import { Auth, } from "aws-amplify";
import {Button} from "@aws-amplify/ui-react";
import Link from "next/link";
import { ConsoleLogger } from "@aws-amplify/core";
//import CodeBlock from "../../components/CodeBlock";
import { useRouter } from "next/router";
//import CodeControlBar from "../../components/CodeControlBar";
import { API, graphqlOperation } from "aws-amplify";
import * as queries from "../../graphql/queries";
import * as mutations from "../../graphql/mutations";
import { Project, ListProjectsQuery } from "../../API";
import { useEffect, useState } from "react";
//import { useUser } from "../context/AuthContext"
import awsconfig from "../../aws-exports"
import Logo from "next/image";
// import {Paper} from "@material-ui/core";
// import GraphQLAPI from "@aws-amplify/api-graphql";
// import Login from "../login";

// const QUERY_LIST_OF_COUNTRIES = `
//   {
//     query ListProjects {
//       pid
//       pName
//     }
//   }
// `;

const initialFormState = {
  title: '', language: '', formType: 'createProject'
}

export default function Home(props:any) {
  
  API.configure(awsconfig);
  const [loggedIn,setLoggedIn] = useState(true)
  const [user, updateUser] = useState(null)
  const [uname, setUsername] = useState(null)

  useEffect(() => {

    async function AccessLoggedInState() {
      try {
          const user = await Auth.currentAuthenticatedUser();
          updateUser(user);
          setUsername(user.username);
          console.log(user);
          setLoggedIn(true);
          // router.push("/home");
          return true
      } catch {
        setLoggedIn(false);
        return false
      }
    }

    AccessLoggedInState()
  }, [])


  const router = useRouter();
  const { pid, pName } = router.query;
  console.log(pid);
  console.log(pName);
  //const { user } = useUser();
  
  const [ project, setProject ] = useState<any[]>([]);
  const [ sharedProject, setSharedProject ] = useState<any[]>([]);
  const [ title, setTitle ] = useState();
  const [ language, setLanguage ] = useState();
  const [ newProject, setCreateProject ] = useState();
  
  // const allProjects = await API.graphql(graphqlOperation(listProjects));
  // project = 10 setProject(10)
  useEffect(() => {
    
    const fetchProject = async ()  => {
      const project = await API.graphql(graphqlOperation(queries.listProjects));
      //  as {
      //   data: Project;
      //   error: any;
      // };
      console.log(project)
      setProject(project.data.listProjects.items)
      // setProject(project.data.items)
      // return project
    };

    fetchProject();

    const fetchSharedProject = async () => {
      const sharedProject = await API.graphql(graphqlOperation(queries.listProjects, {filter: {shareTo: {attributeExists: true}}}))
      console.log(sharedProject.data.listProjects.items)
      setSharedProject(sharedProject.data.listProjects.items)
    };

    fetchSharedProject()

  }, [newProject]); // immediate update the new Project to the home

  const [ formState, updateFormState ] = useState(initialFormState)
  const { formType } = formState

  const createProject = async () => {
    // e.preventDefault()
    // updateFormState(()=>({...formState, [e.target.name]: e.target.value}))

    const projectDetails = {
      projectName: title,
      language: language
    }

    const newProject = await API.graphql(graphqlOperation(mutations.createProject, {input: projectDetails}))
    setCreateProject(newProject)
    console.log("Sucessfully created!")
    // setCreateProject()
  }

  // const createProjectForm = () => {
  //   {
  //     return (
  //       <div>
  //         <form className="createProject">
  //           <input name="title" placeholder="Enter project title" /><br />
  //           <input name="language" placeholder="language" /><br />
  //           <button type='submit'//onClick={()=>createProject()}
  //           >Submit</button>
  //           <Button>Cancel</Button>
  //         </form>
  //       </div>
  //     )
  //   }
  // }
  
  const signOut = async () => {
    try {
      await Auth.signOut();
      setLoggedIn(false);
      router.push("/")
    } catch (error) {
      console.log('error signing out ', error);
    }
  };

 // <CodeBlock language="python" width="100vw" height="90vh" />

  return (
    <div>       
      <Head>
        <title>Code Code Guide fuck you </title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>        
        <div style={{color: "white", backgroundColor: "black", width:"100%"}}> 
          <p className="text-6xl"><Logo src="/Logo.png" alt="me" width="55" height="50" />Code Code Guide</p></div>

        {console.log("Login Status in home:",loggedIn)}
        <div>Welcome on9 {uname}!</div>
        {console.log("formType: ", formType)}
        {/* <div><Button onClick={()=>createProjectForm()}>+</Button></div> */}
        { formType==='createProject' && (
          <div>
            {/* <form className="createProject" onSubmit={()=>createProject()}> */}
              <h1>Enter your Project Title:</h1>
              <input id="title" name="title" placeholder="Enter project title" onChange={e=> setTitle(e.target.value)}/><br />
              <h1>Choose language:</h1>
              <button value="PYTHON" id="python" name="python" onClick={e=> setLanguage(e.target.value)}>PYTHON</button><br />
              <button value="C" id="c" name="c" onClick={e=> setLanguage(e.target.value)}>C</button><br />
              <button value="C++" id="c++" name="c++" onClick={e=> setLanguage(e.target.value)}>C++</button><br />
              <button value="JAVA" id="java" name="java" onClick={e=> setLanguage(e.target.value)}>JAVA</button><br />
              <Button onClick={()=>createProject()}>Create</Button>
              <Button>Cancel</Button>
            {/* </form> */}
          </div>
          )
        }
        <div>New Project to be created: <br/>
          Title: {title} <br />
          Language: {language}
        </div>
        <br/>

        <div className="projectList">
          <h1><b>All Projects</b></h1>
          {
            project.map(item => {
              return (
                <li key={item.id}>
                  {item.projectName}{item.language}{item.updatedAt}
                  {item.shareTo!=null ? <p>{item.shareTo}</p> : <p></p>}
                  <button>Rubbish</button>
                </li>
              )
            })
          }
          
        </div>
        <div className="sharedProjectList">
          <h1><b>Projects that Share to you</b></h1>
          {
            sharedProject.map(item => {
              return (
                <li key={item.id}>
                  {item.projectName}{item.language}{item.updatedAt}{item.shareTo}
                </li>
              )  
            })
          }
          <button>Rubbish</button>
        </div>
        <div>
          <Button onClick={()=>signOut()}>Sign Out</Button>
        </div>

          {/* <div>
            <button onClick={props.signUp}>Help</button>
          </div> */}
        
      </main>
    </div>
  );
};
